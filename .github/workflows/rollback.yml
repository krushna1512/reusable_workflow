name: Rollback Workflow

on:
  workflow_run:
    workflows: ["Deployment Workflow"]
    types:
      - completed

jobs:
  rollback:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Find previous successful release with assets
        id: get_release
        run: |
          echo "üîç Searching for latest successful release WITH assets..."
          RELEASE_NAME=$(gh api repos/${{ github.repository }}/releases \
            --jq 'map(select(.assets | length > 0 and .draft == false and .prerelease == false)) | .[0].name')

          if [ -z "$RELEASE_NAME" ]; then
            echo "‚ùå No previous successful release found with assets!"
            echo "Rollback cannot proceed."
            exit 1
          fi

          echo "‚úî Found rollback release: $RELEASE_NAME"
          echo "LATEST_RELEASE=$RELEASE_NAME" >> $GITHUB_ENV

      - name: Download artifact from previous stable release
        run: |
          echo "‚¨áÔ∏è Downloading artifact from release: $LATEST_RELEASE"
          gh release download "$LATEST_RELEASE" --repo ${{ github.repository }} --dir ./rollback-release --clobber

      - name: Perform Rollback
        run: |
          echo "üö® Rolling back deployment using release: $LATEST_RELEASE"
          ls ./rollback-release || echo "‚ö†Ô∏è No files found"
          echo "üöÄ Rollback completed successfully!"
