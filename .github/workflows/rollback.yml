name: Rollback Workflow

on:
  workflow_run:
    workflows: ["Deployment Workflow"]
    types: [completed]

jobs:
  rollback:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}   # ðŸ‘ˆ Required for gh CLI

    steps:
      - name: Get Latest Successful Release
        id: get_release
        run: |
          RELEASE_NAME=$(gh api repos/${{ github.repository }}/releases \
          --jq 'map(select(.draft==false and .prerelease==false)) | .[0].name')
          echo "LATEST_RELEASE=$RELEASE_NAME" >> $GITHUB_ENV

      - name: Download Artifact from Release
        run: |
          echo "Downloading artifact from $LATEST_RELEASE..."
          gh release download "$LATEST_RELEASE" --repo ${{ github.repository }} --dir ./rollback-release

      - name: Rollback Deployment
        run: |
          echo "Rolling back using release: $LATEST_RELEASE"
          ls ./rollback-release
