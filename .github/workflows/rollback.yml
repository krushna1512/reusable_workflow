name: Rollback Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options: [production, staging]
      release_name:
        description: 'Failed release tag'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Show rollback details
        run: |
          echo "ðŸš¨ Deployment FAILED!"
          echo "ðŸŒ Environment: ${{ github.event.inputs.environment }}"
          echo "âŒ Failed Release: ${{ github.event.inputs.release_name }}"

      - name: Select rollback release
        id: find_tag
        run: |
          echo "ðŸ”Ž Finding previous release for rollback..."

          if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            TAG=$(gh api repos/${{ github.repository }}/releases \
                --jq 'map(select(.prerelease == true and .draft == false)) | .[1].tag_name')
          else
            TAG=$(gh api repos/${{ github.repository }}/releases \
                --jq 'map(select(.prerelease == false and .draft == false)) | .[1].tag_name')
          fi

          if [ -z "$TAG" ]; then
            echo "âŒ No rollback tag found!"
            exit 1
          fi

          echo "rollback_tag=$TAG" >> $GITHUB_OUTPUT
          echo "âœ” Selected rollback target: $TAG"

      - name: Trigger Deployment Workflow (Rollback)
        run: |
          echo "ðŸš€ Triggering deployment workflow with rollback tag..."

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{
              \"release\":\"${{ steps.find_tag.outputs.rollback_tag }}\",
              \"deploy-environment\":\"${{ github.event.inputs.environment }}\",
              \"issue-id\":\"0\"
            }}"

          echo "âœ” Rollback deployment triggered using deploy workflow!"
