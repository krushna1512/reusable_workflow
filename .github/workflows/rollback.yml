name: Rollback Workflow

on:
  workflow_run:
    workflows: ["Deployment Workflow"]   # Must match deploy.yml name exactly
    types:
      - completed

jobs:
  rollback:
    # Run only when deployment workflow fails
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}   # required for gh CLI authentication

    steps:
      - name: Get latest successful release (with assets)
        id: get_release
        run: |
          echo "üîç Finding last successful release with assets..."
          RELEASE_NAME=$(gh api repos/${{ github.repository }}/releases \
            --jq 'map(select(.assets | length > 0 and .draft==false and .prerelease==false)) | .[0].tag_name')
          echo "LATEST_RELEASE=$RELEASE_NAME" >> $GITHUB_ENV
          echo "‚úî Found previous working release: $RELEASE_NAME"

      - name: Download artifact from previous successful release
        run: |
          echo "‚¨áÔ∏è Downloading artifact from release: $LATEST_RELEASE"
          gh release download "$LATEST_RELEASE" --repo ${{ github.repository }} --dir ./rollback-release

      - name: Rollback deployment using previous release
        run: |
          echo "üö® Rolling back deployment using release: $LATEST_RELEASE"
          ls ./rollback-release || echo "‚ö†Ô∏è No files found"
          echo "üöÄ Rollback completed successfully!"
