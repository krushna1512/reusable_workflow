name: Deployment Workflow

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Enter release/tag name (e.g., v1.0.3)'
        required: true
      simulate:
        description: 'Should the deployment succeed or fail?'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - fail
      environment:
        description: 'Select deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      RELEASE_NAME: ${{ github.event.inputs.release_name }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ env.RELEASE_NAME }}

      - name: Simulate Deployment
        run: |
          echo "ðŸš€ Deploying $RELEASE_NAME to $ENVIRONMENT..."
          if [ "${{ github.event.inputs.simulate }}" = "success" ]; then
            echo "Deployment Successful!"
          else
            echo "Deployment Failed!"
            exit 1
          fi

      - name: Trigger Rollback (if failed) via GitHub API
        if: failure()
        run: |
          echo "ðŸ’¥ Deployment failed. Triggering rollback workflow..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/rollback.yml/dispatches \
            -d "{\"ref\":\"main\",\"inputs\":{\"environment\":\"${{ env.ENVIRONMENT }}\",\"release_name\":\"${{ env.RELEASE_NAME }}\"}}"

