name: Rollback Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options: [staging, production]
      release_name:
        description: 'Failed release tag'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Show Inputs
        run: |
          echo "ðŸš¨ Rolling back failed deployment!"
          echo "â— Failed Release: ${{ github.event.inputs.release_name }}"
          echo "ðŸŒ Environment: ${{ github.event.inputs.environment }}"

      - name: Select Previous Release
        run: |
          if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            TAG=$(gh api repos/${{ github.repository }}/releases \
              --jq 'map(select(.prerelease == true)) | .[1].tag_name')
          else
            TAG=$(gh api repos/${{ github.repository }}/releases \
              --jq 'map(select(.prerelease == false and .draft == false)) | .[1].tag_name')
          fi

          echo "ROLLBACK_TAG=$TAG" >> $GITHUB_ENV
          echo "âœ” Selected rollback tag: $TAG"

      - name: Checkout rollback tag
        uses: actions/checkout@v3
        with:
          ref: ${{ env.ROLLBACK_TAG }}

      - name: Rollback Deployment
        run: |
          echo "ðŸš€ Rolling back to version: $ROLLBACK_TAG in ${{ github.event.inputs.environment }}"
